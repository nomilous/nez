// Generated by CoffeeScript 1.6.3
var MonitorFactory, Notice, Objective, Phrase, RealizersFactory, dirname, relative, tools, _ref;

Notice = require('notice');

Phrase = require('phrase');

Objective = require('./objective');

RealizersFactory = require('./realizers');

MonitorFactory = require('./monitor');

tools = require('../tools');

_ref = require('path'), dirname = _ref.dirname, relative = _ref.relative;

module.exports = function(opts, objectiveFn) {
  var Module, error, localopts, missing, required;
  opts.relativePath = relative(process.cwd(), dirname(tools.caller.filename()));
  missing = (function() {
    var _i, _len, _ref1, _results;
    _ref1 = ['title', 'uuid', 'description'];
    _results = [];
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      required = _ref1[_i];
      if (opts[required] != null) {
        continue;
      }
      _results.push(required);
    }
    return _results;
  })();
  if (missing.length > 0) {
    console.log("objective(opts, objectiveFn) requires " + (missing.map(function(p) {
      return "opts." + p;
    }).join(', ')));
    process.exit(1);
  }
  localopts = {
    module: opts.module || '../defaults',
    "class": opts["class"] || 'Develop'
  };
  try {
    Module = require(localopts.module);
    if (Module[localopts["class"]] == null) {
      throw new Error("Could not initialize objective module(=" + localopts.module + ") does not define class(=" + localopts["class"] + ")");
    }
    Objective = Module[localopts["class"]];
  } catch (_error) {
    error = _error;
    try {
      delete opts.listen.secret;
    } catch (_error) {}
    try {
      delete opts.listening;
    } catch (_error) {}
    console.log({
      OPTS: opts,
      ERROR: error
    });
    process.exit(2);
  }
  return Notice.listen("objective/" + opts.uuid, opts, function(error, realizerHub) {
    var event, objective, objectiveMonitor, objectiveRecursor, _i, _len, _ref1, _results;
    if (error != null) {
      try {
        delete opts.listen.secret;
      } catch (_error) {}
      try {
        delete opts.listening;
      } catch (_error) {}
      console.log({
        OPTS: opts,
        ERROR: error
      });
      process.exit(3);
    }
    objectiveRecursor = void 0;
    objectiveMonitor = void 0;
    objective = new Objective;
    objective.configure(opts, function() {
      var Realizers;
      Realizers = RealizersFactory.createClass(opts, realizerHub);
      Realizers.autospawn = opts.autospawn || false;
      objectiveMonitor = MonitorFactory.createFunction(Realizers);
      try {
        objectiveRecursor = Phrase.createRoot(opts, function(objectiveToken, objectiveNotice) {
          objectiveNotice.use(function(msg, next) {
            switch (msg.context.title) {
              case 'phrase::link:directory':
                objectiveMonitor({
                  directory: msg.directory,
                  match: msg.match,
                  ref: 'realizer'
                });
                return next();
              case 'phrase::boundry:assemble':
                return objective.onBoundryAssemble(msg.opts, function(error, phrase) {
                  msg.phrase = phrase;
                  msg.error = error;
                  return next();
                });
              case 'phrase::recurse:end':
                if (msg.root.uuid !== opts.uuid) {
                  return next();
                }
                return Realizers.update(msg.tokens).then(function() {
                  return next();
                });
            }
            return next();
          });
          return objectiveToken.on('ready', function(_arg) {
            var tokens;
            tokens = _arg.tokens;
            return objective.startMonitor(opts, objectiveMonitor, tokens, function(token, opts) {
              return objectiveToken.run(token, opts);
            });
          });
        });
        return objectiveRecursor('objective', objectiveFn || objective.defaultObjective);
      } catch (_error) {
        error = _error;
        try {
          delete opts.listen.secret;
        } catch (_error) {}
        try {
          delete opts.listening;
        } catch (_error) {}
        console.log({
          OPTS: opts,
          ERROR: error
        });
        return process.exit(4);
      }
    });
    _ref1 = ['create', 'delete'];
    _results = [];
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      event = _ref1[_i];
      _results.push((function(event) {
        return objectiveMonitor.dirs.on(event, function(filename, stats, ref) {
          if (ref !== 'realizer') {
            return;
          }
          return objectiveRecursor('objective', objectiveFn || objective.defaultObjective);
        });
      })(event));
    }
    return _results;
  });
};
