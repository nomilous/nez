// Generated by CoffeeScript 1.6.3
var coffee, error, fs, loadRealizer, phrase, program, startRealizer;

program = require('commander');

fs = require('fs');

coffee = require('coffee-script');

phrase = require('phrase');

program.version(JSON.parse(fs.readFileSync(__dirname + '/../../package.json', 'utf8')).version);

program.usage('[options] [realizerFile]');

program.parse(process.argv);

startRealizer = function(_arg) {
  var opts, realizerFn, recursor;
  opts = _arg.opts, realizerFn = _arg.realizerFn;
  recursor = phrase.createRoot(opts, function(token) {
    return token.on('ready', function(_arg1) {
      var path, tokens, _results;
      tokens = _arg1.tokens;
      _results = [];
      for (path in tokens) {
        if (tokens[path].type === 'root') {
          _results.push(token.run(tokens[path]).then(function(resolve) {
            return console.log({
              RESOLVED: resolve
            });
          }, function(reject) {
            return console.log({
              REJECTED: reject
            });
          }, function(notify) {
            return console.log({
              NOTIFY: notify
            });
          }));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    });
  });
  return recursor('realizer', realizerFn);
};

loadRealizer = function(opts) {
  var realizer, realzerFn;
  if (opts.filename == null) {
    console.log('missing realizerFile');
    process.exit(1);
  }
  realizer = fs.readFileSync(opts.filename, 'utf8');
  if (opts.filename.match(/[coffee|litcoffee]$/)) {
    realizer = coffee.compile(realizer, {
      bare: true
    });
  }
  realizer = eval(realizer);
  realzerFn = realizer.realize || function(Signature) {
    return Signature('Title', function(end) {
      return end();
    });
  };
  delete realizer.realize;
  return {
    opts: realizer,
    realizerFn: realzerFn
  };
};

try {
  startRealizer(loadRealizer({
    filename: program.args[0]
  }));
} catch (_error) {
  error = _error;
  console.log(error.message);
  process.exit(2);
}
