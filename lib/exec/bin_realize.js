// Generated by CoffeeScript 1.6.3
var coffee, defer, fs, loadRealizer, phrase, pipeline, program, runRealizer, startRealizer, withError;

program = require('commander');

fs = require('fs');

coffee = require('coffee-script');

phrase = require('phrase');

defer = require('when').defer;

pipeline = require('when/pipeline');

program.version(JSON.parse(fs.readFileSync(__dirname + '/../../package.json', 'utf8')).version);

program.usage('[options] [realizer]');

program.parse(process.argv);

pipeline([
  function() {
    return loadRealizer(program);
  }, function(realizer) {
    return startRealizer(realizer);
  }, function(controls) {
    return runRealizer(controls);
  }
]).then(function(resolve) {
  return console.log({
    RESOLVED: resolve
  });
}, function(error) {
  process.stderr.write(error.toString());
  return process.exit(error.errno || 100);
}, function(notify) {
  return console.log({
    NOTIFY: notify
  });
});

runRealizer = function(_arg) {
  var notice, token;
  token = _arg.token, notice = _arg.notice;
  return token.on('ready', function(_arg1) {
    var path, tokens, _results;
    tokens = _arg1.tokens;
    _results = [];
    for (path in tokens) {
      if (tokens[path].type === 'root') {
        _results.push(token.run(tokens[path]).then(function(resolve) {
          return console.log({
            RESOLVED: resolve
          });
        }, function(reject) {
          return console.log({
            REJECTED: reject
          });
        }, function(notify) {
          return console.log({
            NOTIFY: notify
          });
        }));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  });
};

startRealizer = function(_arg) {
  var opts, realizerFn, start;
  opts = _arg.opts, realizerFn = _arg.realizerFn;
  start = defer();
  process.nextTick(function() {
    var error, recursor;
    recursor = phrase.createRoot(opts, function(token, notice) {
      return start.resolve({
        token: token,
        notice: notice
      });
    });
    try {
      return recursor('realizer', realizerFn);
    } catch (_error) {
      error = _error;
      return console.log({
        ERROR: error
      });
    }
  });
  return start.promise;
};

loadRealizer = function(program) {
  var load;
  load = defer();
  process.nextTick(function() {
    var error, filename, realizer, realzerFn;
    filename = program.args[0];
    if (filename == null) {
      return load.reject(withError(101, 'MISSING_ARG', 'missing realizerFile'));
    }
    try {
      realizer = fs.readFileSync(filename, 'utf8');
    } catch (_error) {
      error = _error;
      return load.reject(error);
    }
    try {
      if (filename.match(/[coffee|litcoffee]$/)) {
        realizer = coffee.compile(realizer, {
          bare: true
        });
      }
    } catch (_error) {
      error = _error;
      return load.reject(error);
    }
    try {
      realizer = eval(realizer);
    } catch (_error) {
      error = _error;
      return load.reject(error);
    }
    realzerFn = realizer.realize || function(Signature) {
      return Signature('Title', function(end) {
        return end();
      });
    };
    delete realizer.realize;
    return load.resolve({
      opts: realizer,
      realizerFn: realzerFn
    });
  });
  return load.promise;
};

withError = function(errno, code, message) {
  var error;
  error = new Error(message);
  error.errno = errno;
  error.code = code;
  return error;
};
